# Flood Detection Results Merger (merge.py)

This script merges flood detection results from multiple GeoTIFF files generated by `run_flood_detection_planetary_computer.py` into a single consolidated raster.

## Overview

The `run_flood_detection_planetary_computer.py` script outputs flood predictions in a directory structure like:
```
results/
├── 2025/
│   ├── 08/
│   │   ├── 10/
│   │   │   ├── file1_flood_prediction.tif
│   │   │   └── file2_flood_prediction.tif
│   │   └── 11/
│   │       ├── file3_flood_prediction.tif
│   │       └── file4_flood_prediction.tif
│   └── 09/
│       └── 01/
│           └── file5_flood_prediction.tif
```

These individual GeoTIFF files:
- May have different coordinate reference systems (CRS)
- Can overlap spatially
- Contain flood predictions with values of 255 (flood) and np.NaN (no flood/no data)

## What the merge script does

1. **Discovers all .tif files** in the directory structure
2. **Reprojects** all rasters to a common CRS (default: EPSG:3857 Web Mercator)
3. **Merges** overlapping rasters using configurable merge strategies
4. **Standardizes values**: np.NaN → 0, 255 → 1
5. **Saves** the result with ZSTD compression and tiling for efficient storage

## Requirements

```bash
pip install rasterio numpy
```

Or with conda:
```bash
conda install -c conda-forge rasterio numpy
```

## Usage

### Basic usage
```bash
python src/merge.py --input_dir results --output merged_flood_predictions.tif
```

### Advanced usage with options
```bash
python src/merge.py \
  --input_dir /path/to/results \
  --output /path/to/merged_output.tif \
  --target_crs EPSG:4326 \
  --merge_method max \
  --compress zstd \
  --tiled \
  --verbose
```

## Command Line Arguments

### Required Arguments
- `--input_dir`: Directory containing the year/month/day structure with .tif files
- `--output`: Output path for the merged GeoTIFF file

### Optional Arguments
- `--target_crs`: Target CRS for reprojection (default: `EPSG:3857`)
- `--resolution`: Target resolution in target CRS units (default: auto-detect)
- `--resampling`: Resampling method (`nearest`, `bilinear`, `cubic`, `average`) (default: `nearest`)
- `--merge_method`: Method for handling overlapping pixels (`first`, `last`, `min`, `max`, `mean`) (default: `max`)
- `--compress`: Compression method (`lzw`, `deflate`, `zstd`, `none`) (default: `zstd`)
- `--tiled`: Create tiled output (default: `True`)
- `--tile_size`: Tile size for tiled output (default: `512`)
- `--verbose`: Enable verbose output

## Merge Methods

- **first**: Use the first (earliest processed) value at each pixel
- **last**: Use the last (latest processed) value at each pixel  
- **min**: Use the minimum value at each pixel
- **max**: Use the maximum value at each pixel (recommended for flood detection)
- **mean**: Use the average value at each pixel

## Output Format

The output is a GeoTIFF file with:
- **Values**: 0 (no flood), 1 (flood)
- **Data type**: uint8
- **NoData value**: 0
- **Compression**: ZSTD (or specified compression)
- **Tiling**: 512x512 tiles (or specified tile size)
- **CRS**: EPSG:3857 (or specified target CRS)

## Examples

### Merge with maximum flood detection confidence
```bash
python src/merge.py \
  --input_dir results \
  --output final_flood_map.tif \
  --merge_method max \
  --verbose
```

### Merge to geographic coordinates (WGS84)
```bash
python src/merge.py \
  --input_dir results \
  --output flood_map_geographic.tif \
  --target_crs EPSG:4326 \
  --resolution 0.0001
```

### Merge with custom compression and tiling
```bash
python src/merge.py \
  --input_dir results \
  --output flood_map_custom.tif \
  --compress deflate \
  --tile_size 256
```

## Performance Considerations

- **Memory usage**: The script loads and processes rasters in memory. For very large datasets, consider processing subsets or using a machine with sufficient RAM.
- **Processing time**: Reprojection and merging can be time-intensive for large datasets. Use `--verbose` to monitor progress.
- **Output size**: ZSTD compression typically provides good compression ratios for binary flood maps.

## Integration with Other Tools

The output raster can be used with:
- **QGIS**: Direct import for visualization and analysis
- **Python**: Using rasterio, GDAL, or other geospatial libraries
- **Web mapping**: Convert to tiles for web display
- **R**: Using terra, raster, or sf packages
- **PostGIS**: Import as raster data for spatial database operations

## Troubleshooting

### "No .tif files found"
- Check that the input directory contains the expected structure
- Verify file extensions (.tif or .tiff)
- Ensure you have read permissions on the directory

### Memory errors
- Process smaller subsets of data
- Use a machine with more RAM
- Consider using a lower resolution target

### Projection errors
- Verify that input files have valid CRS information
- Try using a different target CRS
- Check for corrupted input files

### Performance issues
- Use `--verbose` to identify bottlenecks
- Consider using faster resampling methods
- Reduce tile size for memory-constrained systems